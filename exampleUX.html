import React, { useState, useEffect, useRef } from 'react';
import { Heart, Trash2, SkipForward, Play, Pause } from 'lucide-react';

/**
 * FloatingLines 组件：使用 Three.js 创建流动的绿色加粗光晕背景
 */
const FloatingLines = ({
  linesGradient = ['#17C9A8', '#4DB6AC', '#80CBC4', '#B2DFDB'], 
  animationSpeed = 0.2,
  interactive = true,
  parallaxStrength = 0.06,
}) => {
  const containerRef = useRef(null);
  const targetParallaxRef = useRef({ x: 0, y: 0 });
  const currentParallaxRef = useRef({ x: 0, y: 0 });

  useEffect(() => {
    if (!containerRef.current) return;

    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js";
    script.async = true;
    script.onload = initThree;
    document.head.appendChild(script);

    function initThree() {
      const THREE = window.THREE;
      if (!THREE) return;

      const vertexShader = `
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `;

      const fragmentShader = `
        precision highp float;
        uniform float iTime;
        uniform vec3 iResolution;
        uniform float animationSpeed;
        uniform vec2 parallaxOffset;
        uniform vec3 lineGradient[4];

        mat2 rotate(float r) {
          return mat2(cos(r), sin(r), -sin(r), cos(r));
        }

        float wave(vec2 uv, float offset, float ampMult) {
          float time = iTime * animationSpeed;
          float x_movement = time * 0.1;
          float amp = sin(offset + time * 0.2) * 0.12 * ampMult;
          float y = sin(uv.x + offset + x_movement) * amp;
          return 0.06 / max(abs(uv.y - y) + 0.025, 0.001);
        }

        void main() {
          vec2 fragCoord = gl_FragCoord.xy;
          vec2 uv = (2.0 * fragCoord - iResolution.xy) / iResolution.y;
          uv += parallaxOffset;
          vec3 col = vec3(1.0, 1.0, 1.0); 
          
          float w1 = wave(uv * rotate(0.4) + vec2(2.0, -0.7), 1.5, 1.0);
          col = mix(col, lineGradient[0], w1 * 0.2);

          float w2 = wave(uv * rotate(-0.2) + vec2(5.0, 0.2), 2.0, 0.8);
          col = mix(col, lineGradient[1], w2 * 0.25);

          float w3 = wave(uv * rotate(0.1) + vec2(-3.0, 0.5), 1.0, 1.2);
          col = mix(col, lineGradient[2], w3 * 0.2);

          gl_FragColor = vec4(col, 1.0);
        }
      `;

      const scene = new THREE.Scene();
      const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      const el = containerRef.current;
      renderer.setSize(el.clientWidth, el.clientHeight);
      el.appendChild(renderer.domElement);

      const hexToVec3 = (hex) => {
        const h = hex.replace('#', '');
        return new THREE.Vector3(
          parseInt(h.substring(0, 2), 16) / 255,
          parseInt(h.substring(2, 4), 16) / 255,
          parseInt(h.substring(4, 6), 16) / 255
        );
      };

      const uniforms = {
        iTime: { value: 0 },
        iResolution: { value: new THREE.Vector3(el.clientWidth, el.clientHeight, 1) },
        animationSpeed: { value: animationSpeed },
        parallaxOffset: { value: new THREE.Vector2(0, 0) },
        lineGradient: { value: linesGradient.map(hexToVec3) }
      };

      const material = new THREE.ShaderMaterial({ uniforms, vertexShader, fragmentShader, transparent: true });
      const mesh = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material);
      scene.add(mesh);

      const onResize = () => {
        renderer.setSize(el.clientWidth, el.clientHeight);
        uniforms.iResolution.value.set(el.clientWidth, el.clientHeight, 1);
      };
      window.addEventListener('resize', onResize);

      const onPointerMove = (e) => {
        const rect = el.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        const y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
        targetParallaxRef.current = { x: x * parallaxStrength, y: y * parallaxStrength };
      };
      if (interactive) window.addEventListener('pointermove', onPointerMove);

      let raf;
      const clock = new THREE.Clock();
      const animate = () => {
        uniforms.iTime.value = clock.getElapsedTime();
        currentParallaxRef.current.x += (targetParallaxRef.current.x - currentParallaxRef.current.x) * 0.05;
        currentParallaxRef.current.y += (targetParallaxRef.current.y - currentParallaxRef.current.y) * 0.05;
        uniforms.parallaxOffset.value.set(currentParallaxRef.current.x, currentParallaxRef.current.y);
        renderer.render(scene, camera);
        raf = requestAnimationFrame(animate);
      };
      animate();

      return () => {
        cancelAnimationFrame(raf);
        window.removeEventListener('resize', onResize);
        window.removeEventListener('pointermove', onPointerMove);
        renderer.dispose();
      };
    }
  }, []);

  return <div ref={containerRef} className="fixed inset-0 z-0 pointer-events-none" />;
};

const App = () => {
  const [dbTracks] = useState([
    {
      id: 1,
      title: "The Moon Is Falling",
      author: "Serendipity Night",
      cover: "https://images.unsplash.com/photo-1532667449560-72a95c8d381b?w=600&h=600&fit=crop",
      audioUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
      duration: 206
    },
    {
      id: 2,
      title: "从此以后，朋友管我的相亲对象叫“满月哥”",
      author: "向向向生活低头",
      cover: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=600&h=600&fit=crop",
      audioUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
      duration: 145
    }
  ]);

  const [currentTrackIndex, setCurrentTrackIndex] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [liked, setLiked] = useState({});
  const [progress, setProgress] = useState(0);
  const audioRef = useRef(new Audio());

  const currentTrack = dbTracks[currentTrackIndex];

  useEffect(() => {
    const audio = audioRef.current;
    audio.src = currentTrack.audioUrl;
    const updateProgress = () => setProgress((audio.currentTime / audio.duration) * 100);
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('ended', handleNext);
    if (isPlaying) audio.play().catch(() => {});
    return () => {
      audio.removeEventListener('timeupdate', updateProgress);
      audio.removeEventListener('ended', handleNext);
    };
  }, [currentTrackIndex]);

  const togglePlay = () => {
    if (isPlaying) audioRef.current.pause();
    else audioRef.current.play();
    setIsPlaying(!isPlaying);
  };

  const handleNext = () => {
    setCurrentTrackIndex((currentTrackIndex + 1) % dbTracks.length);
    setIsPlaying(true);
  };

  return (
    <div className="min-h-screen flex flex-col selection:bg-[#17C9A8]/10 relative overflow-hidden bg-white">
      {/* 字体引入与排版样式 */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500&display=swap');

        :root {
          --apple-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        body {
          font-family: var(--apple-font);
          -webkit-font-smoothing: antialiased;
        }
        .apple-title {
          font-weight: 600;
          letter-spacing: -0.025em;
        }
        .apple-sub {
          font-weight: 400;
          letter-spacing: -0.012em;
          color: #86868b;
        }
        .philosophy-font {
          font-family: 'Cormorant Garamond', serif;
          font-size: 16px;
          letter-spacing: 0.02em;
          color: #6e6e73;
        }
        @keyframes bounce {
          0%, 100% { height: 4px; }
          50% { height: 16px; }
        }
        .line-clamp-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;  
          overflow: hidden;
        }
      `}</style>
      
      <FloatingLines />

      {/* 顶部标题 */}
      <header className="px-16 py-12 w-full max-w-7xl mx-auto flex-shrink-0 z-10 relative">
        <div className="flex flex-col">
          <h1 className="apple-title text-[32px] text-[#1d1d1f] leading-[1.1] mb-1">
            Serendipity FM
          </h1>
          {/* 更换字体，去掉斜体，增加哲思感 */}
          <p className="philosophy-font opacity-90">
            所有的随机，都是灵魂在此时此刻的重逢。
          </p>
        </div>
      </header>

      {/* 主区域 */}
      <main className="flex-1 flex justify-center items-center px-6 z-10 relative">
        <div className="w-full max-w-[620px] bg-white/60 backdrop-blur-3xl border border-white/80 shadow-[0_20px_60px_rgba(0,0,0,0.04)] rounded-[48px] p-7 flex flex-col md:flex-row gap-8 transition-all duration-1000">
          
          {/* 左侧封面 */}
          <div className="w-full md:w-[260px] aspect-square rounded-[36px] overflow-hidden flex-shrink-0 relative shadow-lg">
            <img 
              key={currentTrack.cover} 
              src={currentTrack.cover} 
              alt="cover" 
              className="w-full h-full object-cover transition-transform duration-[3s] hover:scale-105" 
            />
            {isPlaying && (
              <div className="absolute top-6 right-6 flex items-end space-x-1 h-4 z-20">
                <div className="w-0.5 bg-white/80 animate-[bounce_1s_infinite]"></div>
                <div className="w-0.5 bg-white/80 animate-[bounce_1.4s_infinite]"></div>
                <div className="w-0.5 bg-white/80 animate-[bounce_0.8s_infinite]"></div>
              </div>
            )}
          </div>

          {/* 右侧控制区 */}
          <div className="flex-1 py-3 pr-3 flex flex-col justify-between relative">
            
            <button 
              onClick={togglePlay} 
              className="absolute top-0 right-0 w-14 h-14 bg-[#17C9A8] text-white rounded-full flex items-center justify-center shadow-lg hover:bg-[#14b395] hover:scale-105 active:scale-95 transition-all"
            >
              {isPlaying ? <Pause size={24} fill="currentColor" /> : <Play size={24} fill="currentColor" className="ml-1" />}
            </button>

            <div className="mt-4 pr-16">
              <span className="text-[11px] text-[#17C9A8] font-bold tracking-[0.2em] mb-3 block uppercase opacity-80">Shuffle Museum</span>
              <h2 className="apple-title text-[21px] mb-1.5 text-[#1d1d1f] line-clamp-2 leading-tight">
                {currentTrack.title}
              </h2>
              <p className="apple-sub text-[14px] mb-8 truncate font-normal">{currentTrack.author}</p>
              
              <div className="mt-10">
                <div className="flex justify-between apple-sub text-[11px] mb-2 uppercase font-medium">
                  <span className="truncate max-w-[100px]">{currentTrack.author}</span>
                  <span>-{Math.floor((currentTrack.duration * (100 - progress)) / 100)}s</span>
                </div>
                <div className="h-[3px] w-full bg-gray-200/50 rounded-full overflow-hidden">
                  <div 
                    style={{ width: `${progress}%` }} 
                    className="h-full bg-[#17C9A8] transition-all duration-300 ease-linear" 
                  />
                </div>
              </div>
            </div>

            {/* 控制按钮组 */}
            <div className="flex items-center space-x-6 pt-4">
              <button 
                onClick={() => setLiked(p => ({...p, [currentTrack.id]: !p[currentTrack.id]}))} 
                className={`w-12 h-12 rounded-full flex items-center justify-center transition-all hover:scale-110 active:scale-95 ${liked[currentTrack.id] ? 'bg-red-50 text-red-500 shadow-sm' : 'bg-gray-100/60 text-gray-400 hover:bg-gray-200/80 hover:text-gray-600'}`}
              >
                <Heart size={20} fill={liked[currentTrack.id] ? "currentColor" : "none"} strokeWidth={2} />
              </button>
              <button 
                onClick={handleNext} 
                className="w-12 h-12 rounded-full bg-gray-100/60 text-gray-400 flex items-center justify-center transition-all hover:bg-gray-200/80 hover:text-gray-600 hover:scale-110 active:scale-95"
              >
                <Trash2 size={20} strokeWidth={2} />
              </button>
              <button 
                onClick={handleNext} 
                className="w-12 h-12 rounded-full bg-gray-100/60 text-gray-400 flex items-center justify-center transition-all hover:bg-[#17C9A8]/10 hover:text-[#17C9A8] hover:scale-110 active:scale-95"
              >
                <SkipForward size={20} fill="currentColor" strokeWidth={2} />
              </button>
            </div>
          </div>
        </div>
      </main>

      {/* 页脚文字修改 */}
      <footer className="py-12 flex-shrink-0 z-10 relative">
        <div className="max-w-7xl mx-auto px-16 apple-sub text-[11px] text-center md:text-left opacity-70">
          Serendipity FM &bull; 随机播放 · 遇见惊喜
        </div>
      </footer>
    </div>
  );
};

export default App;